I"[<p>Signing the builds offline, preferably using a yubikey / nitrokey or a hsm as appropriate.</p>

<hr />

<p>The below text is for signing using smartcards.</p>

<p>TL;DR: Doable, some stuff already has external hooks, some might not but could easily be added.</p>

<h5 id="todos">TODOs</h5>
<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Figure out what hardware can be used (e.g. can the yubikey 4c be used? - nope, need a hsm)</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Figure out the code changes needed to the AOSP releasetools (see if anyone else has done it while we’re at it) - halfway there</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Document the changes below</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Differences between signing the apks and the builds (system/vendor/boot verity/avb)</li>
</ul>

<h3 id="hardware">Hardware</h3>
<h4 id="yubikey-4c-nano-cdesai">Yubikey 4C Nano (cdesai)</h4>
<ul>
  <li>Supports smartcard (PIV)</li>
  <li>Has 24 slots to store various keys</li>
</ul>

<p>What I’ve done so far:</p>
<ul>
  <li>Generate private pem files from the pk8 files (<code class="language-plaintext highlighter-rouge">openssl pkcs8 -in ${i}.pk8 -inform DER -out ${i}.pem</code>)</li>
  <li>Import the private keys and certs to yubikey, 4 slots available (<code class="language-plaintext highlighter-rouge">yubico-piv-tool -s $slot -a import-key -i $file</code> - and matching import-certificate)
    <ul>
      <li>9a = Certificate for PIV Authentication = releasekey - works with jarsigner and apksigner</li>
      <li>9c = Certificate for Digital Signature = platform - doesn’t work</li>
      <li>9d = Certificate for Key Management = media - doesn’t work</li>
      <li>9e = Certificate for Card Authentication = shared - works with jarsigner and apksigner</li>
    </ul>
  </li>
  <li>Slots 82-95 can also be used to store keys but I can’t find a way to access them.</li>
  <li>Use the yubikey signing instructions with the right alias to sign with the desired key.</li>
</ul>

<h3 id="signing-process-keys-used">Signing process, keys used</h3>
<h4 id="keys">Keys:</h4>
<h5 id="mediasharedplatformreleasekeypk8x509pem">{media,shared,platform,releasekey}.pk8,x509.pem</h5>
<ul>
  <li>Used for signing apps, same process as app signing - common to all devices
    <h5 id="veritypk8x509pem-verity_keypub">verity.pk8,x509.pem verity_key.pub</h5>
  </li>
  <li>Verified boot - Pixel 1, Mi A2
    <h5 id="avbpem-avb_pkmdbin">avb.pem, avb_pkmd.bin</h5>
  </li>
  <li>Android Verified Boot 2.0 - Pixel 2</li>
</ul>

<h4 id="steps">Steps</h4>
<p>The various steps during the signing process.
Note: Only the steps dealing with the actual signing process are listed here.</p>
<h5 id="commonpysignfile-used-to-sign-zipjarapk">common.py:SignFile (used to sign zip/jar/apk)</h5>
<ul>
  <li>
    <p>extra_signapk_args could be used to pass arguments invoking hsm</p>

    <p>Modifications needed:</p>
    <ul>
      <li>This invokes signapk, which does support -providerClass but not -providerArg. It also assumes having public and private keys on the file system, so that code would need to be refactored.</li>
      <li>We can specify a custom signapk.jar, I wonder if we should just fork the AOSP version instead of trying to modify it in place.</li>
      <li>The good news is that signapk does most of the apk signing through the library apksig-core, which is what’s in apksigner, which does fully support using a yubikey. (See geoffreymetais blogpost below)
        <h5 id="verity---java-python">verity - java, python</h5>
      </li>
    </ul>
  </li>
  <li>boot_signer: uses verity.pk8,x509.pem with boot.img</li>
  <li>system/extras/verity/build_verity_metadata.py used with the other images (system/vendor)</li>
  <li>
    <p>Uses standard java APIs, so this should probably be a drop-in</p>

    <p>Modifications needed:</p>
    <ul>
      <li>Everything in system/extras/verity is hardcoded to deal with private key files.</li>
      <li>Would need to refactor that to deal with our PKCS#11 keys.</li>
      <li>
        <p>Good news is, reading the java security docs does seem to imply that most of the same methods can be</p>

        <p>used, and they can deal with private keys which are just java software keys and not actually present in files (but present on the token).</p>
      </li>
      <li>Need to test the above in theory</li>
    </ul>
  </li>
</ul>

<h5 id="avbtool-make_vbmeta_image---c">avbtool make_vbmeta_image - C++</h5>
<ul>
  <li>uses avb.pem to create the vbmeta image</li>
  <li>Also used: add_hash_footer with all the other partitions (system/vendor/boot/dtbo)</li>
  <li>
    <p>–signing_helper can be used (see external/avb/README.md) - would need development of a small script to communicate</p>

    <p>Modifications needed:</p>
    <ul>
      <li>A few lines in build/tools/releasetools to call the external signing helper.</li>
      <li>Not actually a modification but actually writing the signing helper.</li>
      <li>Unsure if signing_helper actually works, will need to test.</li>
    </ul>
  </li>
</ul>

<h5 id="useful-links">Useful links</h5>
<ul>
  <li>https://source.android.com/devices/tech/ota/sign_builds</li>
  <li>https://guardianproject.info/2014/03/28/security-in-a-thumb-drive-the-promise-and-pain-of-hardware-security-modules-take-one/</li>
  <li>https://gitlab.com/fdroid/fdroidserver/commit/3829d37d341433c9e30c9069928e3fe6b4d824c1</li>
  <li>https://developers.yubico.com/PIV/Guides/Android_code_signing.html</li>
  <li>https://guardianproject.info/2017/12/18/building-a-signing-server/</li>
  <li>https://developers.yubico.com/PIV/Introduction/Certificate_slots.html</li>
  <li>https://developers.yubico.com/PIV/Introduction/YubiKey_and_PIV.html</li>
  <li>https://utcc.utoronto.ca/~cks/space/blog/sysadmin/Yubikey4ForSSHKeys</li>
  <li>https://geoffreymetais.github.io/code/key-signing/</li>
  <li>https://raymii.org/s/articles/Decrypt_NitroKey_HSM_or_SmartCard-HSM_private_keys.html</li>
  <li>https://github.com/OpenSC/OpenSC/issues/847</li>
  <li>https://docs.oracle.com/javase/7/docs/technotes/guides/security/p11guide.html</li>
</ul>
:ET