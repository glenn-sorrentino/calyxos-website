I"i<p>The firewall could generally be considered to be composed of 3 layers for each of its features. A UI layer, the frameworks layer (see <a href="https://developer.android.com/guide/platform#api-framework">https://developer.android.com/guide/platform#api-framework</a>), and the netd layer (see <a href="https://developer.android.com/guide/platform#native-libs">https://developer.android.com/guide/platform#native-libs</a>).</p>

<h3 id="ui">UI</h3>
<p>This is the layer visibly exposed to users (toggles, text, …).
It is responsible for passing down information (global toggle switched or app restriction applied, in which case it sends the UID of the app and the policy or rule related to the feature) about a user’s selection to the frameworks for processing.</p>

<h3 id="frameworks">Frameworks</h3>
<p>Responsible for the first level of processing (e.g. sanity checks, state machine, …), managing the dynamics of a feature (e.g. app in background) and passing down the inputs to netd to apply policies and rules.</p>

<h3 id="netd">Netd</h3>
<p>At its core, the firewall makes use of standard Linux networking utilities to process traffic (see <a href="https://source.android.com/devices/architecture/hidl/network-stack">https://source.android.com/devices/architecture/hidl/network-stack</a>). Netd is responsible for the last level of processing and calls the networking utilities, passing in the input for any operation.</p>

<h2 id="features">Features</h2>

<h3 id="per-interface-network-usage-restrictions">Per-interface network usage restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:data-restriction">https://review.calyxos.org/q/topic:data-restriction</a></li>
</ul>

<p>On devices with Linux kernel versions 4.9 and below, this setting uses iptables to add an app to the INPUT and OUTPUT chains and limits its traffic based on the specified incoming and outgoing networking interface.
On devices with Linux kernel versions higher than 4.9, the bandwidth restrictions make use of eBPF instead of iptables (see https://source.android.com/devices/tech/datausage/ebpf-traffic-monitor)</p>

<h3 id="per-app-network-isolation">Per-app network isolation</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:network-isolation">https://review.calyxos.org/q/topic:network-isolation</a></li>
</ul>

<p>On devices with Linux kernel versions 4.9 and below, this setting uses iptables to add an app to the firewall isolated chain (which is referenced in the firewall INPUT and OUTPUT chains).
On devices with Linux kernel versions higher than 4.9, the bandwidth restrictions make use of eBPF instead of iptables (see https://source.android.com/devices/tech/datausage/ebpf-traffic-monitor)</p>

<h3 id="background-network-access-restrictions">Background network access restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:background-data">https://review.calyxos.org/q/topic:background-data</a></li>
</ul>

<p>This setting adds an app to the penalty box iptables chain. On AOSP, this chain can be reached via costly interface chains (metered networks, which mobile data and VPN networks default to, are considered costly). In CalyxOS, the penalty box is instead added at the bandwidth INPUT, OUTPUT and FORWARD chains so that all interfaces block background bandwidth</p>

<h3 id="cleartext-traffic-restrictions">Cleartext traffic restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:global-no-cleartext">https://review.calyxos.org/q/topic:global-no-cleartext</a></li>
  <li>Code: <a href="https://review.calyxos.org/q/topic:global-no-cleartext-allowlist">https://review.calyxos.org/q/topic:global-no-cleartext-allowlist</a></li>
</ul>

<p>The global cleartext restriction setting adds the cleartext detection chain to the strict mode OUTPUT chain and adds either the log or the reject penalty chain to the cleartext caught chain (which is part of the detection chain).
Additionally, a DNS whitelist chain is created (and inserted in the caught chain before the penalty chain) to allow udp traffic to the DNS port of a DNS address in order to establish a private DNS connection. Once established, the rule is removed.
In AOSP, each app can make and remove its own strict mode cleartext restriction chain. In CalyxOS, instead of the chain being removed an ACCEPT is applied. These chains are inserted before the global rule thereby taking priority over it.</p>
:ET